class TwentyFourDataView extends DataView{getUint24(t,e){if(e)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(t-1)}setUint24(t,e,a){if(a)throw"littleEndian int24 not implemented";if(e>16777215)throw"setUint24: number out of range";let i=e>>16,r=65535&e;this.setUint8(t,i),this.setUint16(t+1,r)}indexOf(t,e=0,a=this.byteLength-t.length+1){if(t.charCodeAt){for(let i=e;i<a;i++){if(this.getUint8(i)!=t.charCodeAt(0))continue;let e=1;for(let a=0;a<t.length;a++)if(this.getUint8(i+a)!=t.charCodeAt(a)){e=0;break}if(e)return i}return-1}for(let i=e;i<a;i++){if(this.getUint8(i)!=t[0])continue;let e=1;for(let a=0;a<t.length;a++)if(this.getUint8(i+a)!=t[a]){e=0;break}if(e)return i}return-1}}class FLVTag{constructor(t,e=0){this.tagHeader=new TwentyFourDataView(t.buffer,t.byteOffset+e,11),this.tagData=new TwentyFourDataView(t.buffer,t.byteOffset+e+11,this.dataSize),this.previousSize=new TwentyFourDataView(t.buffer,t.byteOffset+e+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let t;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(t=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(t+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let t=this.tagData.indexOf("duration\0");if(-1==t)throw"can not get flv meta duration";return t+=9,this.tagData.getFloat64(t)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let t=this.tagData.indexOf("duration\0");if(-1==t)throw"can not get flv meta duration";return t+=9,{duration:this.tagData.getFloat64(t),durationDataView:new TwentyFourDataView(this.tagData.buffer,this.tagData.byteOffset+t,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(t){if(t<0)throw"timestamp < 0";this.tagHeader.setUint8(7,t>>24),this.tagHeader.setUint24(4,16777215&t)}}class FLV{constructor(t){if(0!=t.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new TwentyFourDataView(t.buffer,t.byteOffset,9),this.firstPreviousTagSize=new TwentyFourDataView(t.buffer,t.byteOffset+9,4),this.tags=[];let e=this.headerLength+4;for(;e<t.byteLength;){let a=new FLVTag(t,e);e+=11+a.dataSize+4,this.tags.push(a)}if(e!=t.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(t){if(t.length<1)throw"Usage: FLV.merge([flvs])";let e,a=[],i=[0,0],r=[0,0],n=0;a.push(t[0].header),a.push(t[0].firstPreviousTagSize);for(let s of t){let o=1e3*n;i[0]=r[0],i[1]=r[1],o=Math.max(o,i[0],i[1]);let g=0;for(let i of s.tags)18!=i.tagType||g?8!=i.tagType&&9!=i.tagType||(r[i.tagType-8]=o+i.getCombinedTimestamp(),i.setCombinedTimestamp(r[i.tagType-8]),a.push(i.tagHeader),a.push(i.tagData),a.push(i.previousSize)):(n+=i.getDuration(),g=1,s==t[0]&&(({duration:n,durationDataView:e}=i.getDurationAndView()),i.stripKeyframesScriptData(),a.push(i.tagHeader),a.push(i.tagData),a.push(i.previousSize)))}return e.setFloat64(0,n),new Blob(a)}static async mergeBlobs(t){if(t.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let e,a=[],i=[0,0],r=[0,0],n=0;for(let s of t){let o=1e3*n;i[0]=r[0],i[1]=r[1],o=Math.max(o,i[0],i[1]);let g=0,h=await new Promise((t,e)=>{let a=new FileReader;a.onload=(()=>t(new FLV(new TwentyFourDataView(a.result)))),a.readAsArrayBuffer(s),a.onerror=e}),u=[];for(let i of h.tags)18!=i.tagType||g?8!=i.tagType&&9!=i.tagType||(r[i.tagType-8]=o+i.getCombinedTimestamp(),i.setCombinedTimestamp(r[i.tagType-8]),u.push(i.tagHeader,i.tagData,i.previousSize)):(n+=i.getDuration(),g=1,s==t[0]&&(a.push(h.header,h.firstPreviousTagSize),({duration:n,durationDataView:e}=i.getDurationAndView()),i.stripKeyframesScriptData(),a.push(i.tagHeader),a.push(i.tagData),a.push(i.previousSize)));a.push(new Blob(u))}return e.setFloat64(0,n),new Blob(a)}}